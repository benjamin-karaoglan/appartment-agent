# Docker Compose override for using Google Cloud Storage instead of MinIO
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.gcs.yml up -d backend frontend db redis
#   OR
#   ./dev.sh start-gcs
#
# Requirements:
#   1. Set GCS_DOCUMENTS_BUCKET and GCS_PHOTOS_BUCKET in your .env
#   2. Setup Application Default Credentials (ADC)
#
# Recommended: Use Service Account Impersonation
# =============================================
# This approach gives you the same permissions as the production service account
# without needing to download key files.
#
#   # 1. Grant yourself permission to impersonate (one-time)
#   gcloud iam service-accounts add-iam-policy-binding \
#     appart-backend@YOUR_PROJECT.iam.gserviceaccount.com \
#     --member="user:YOUR_EMAIL@gmail.com" \
#     --role="roles/iam.serviceAccountTokenCreator" \
#     --project=YOUR_PROJECT
#
#   # 2. Login with impersonation
#   gcloud auth application-default login \
#     --impersonate-service-account=appart-backend@YOUR_PROJECT.iam.gserviceaccount.com
#
#   # 3. Start services
#   ./dev.sh start-gcs
#
# Alternative: Direct ADC (uses your personal Google account permissions)
# =======================================================================
#   gcloud auth application-default login
#   ./dev.sh start-gcs

services:
  backend:
    environment:
      # Switch storage backend to GCS
      STORAGE_BACKEND: gcs

      # GCS bucket configuration (set these in your .env or export them)
      GCS_DOCUMENTS_BUCKET: ${GCS_DOCUMENTS_BUCKET:-}
      GCS_PHOTOS_BUCKET: ${GCS_PHOTOS_BUCKET:-}
      GCS_SIGNING_SERVICE_ACCOUNT: ${GCS_SIGNING_SERVICE_ACCOUNT:-}

      # Google Cloud configuration
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT}
      GOOGLE_APPLICATION_CREDENTIALS: /app/.secrets/adc.json

    volumes:
      # Mount Google Cloud credentials
      # Option 1: Use ADC from gcloud auth application-default login
      - ${GOOGLE_APPLICATION_CREDENTIALS:-~/.config/gcloud/application_default_credentials.json}:/app/.secrets/adc.json:ro

    # Override depends_on to remove minio dependency
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
